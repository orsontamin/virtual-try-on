/**
 * MASTER BRIDGE: GOOGLE GEMINI AI + VTO PREDICTION + DRIVE STORAGE
 * 
 * INSTRUCTIONS:
 * 1. Go to https://script.google.com
 * 2. Create a New Project.
 * 3. Replace all code in 'Code.gs' with the CONTENT section below.
 * 4. Click 'Project Settings' (cog icon) and check "Show 'appsscript.json' manifest file in editor".
 * 5. Open 'appsscript.json' in the editor and replace its content with the MANIFEST section below.
 * 6. Click 'Deploy' > 'New Deployment'.
 * 7. Select 'Web App', 'Execute As: Me', 'Who has access: Anyone'.
 * 8. Click 'Deploy' and authorize all permissions.
 * 9. Copy the Web App URL to your VITE_GOOGLE_BRIDGE_URL in .env.local.
 */

// --- SECTION 1: CONTENT (Code.gs) ---

function doPost(e) {
  var data;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ error: "Invalid JSON input" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  var action = data.action;

  if (action === 'gemini') {
    return handleGemini(data.payload);
  } else if (action === 'vto') {
    return handleVTO(data.payload);
  } else if (action === 'upload') {
    return handleUpload(data.base64, data.filename);
  } else {
    return ContentService.createTextOutput(JSON.stringify({ error: "Unknown action" }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function handleGemini(payload) {
  var PROJECT_ID = "premium-carving-481411-d2";
  var LOCATION_ID = "us-central1";
  var url = "https://" + LOCATION_ID + "-aiplatform.googleapis.com/v1/projects/" + PROJECT_ID + "/locations/" + LOCATION_ID + "/publishers/google/models/gemini-2.5-flash:generateContent";
  return proxyVertex(url, payload);
}

function handleVTO(payload) {
  var PROJECT_ID = "premium-carving-481411-d2";
  var LOCATION_ID = "asia-southeast1";
  var url = "https://" + LOCATION_ID + "-aiplatform.googleapis.com/v1/projects/" + PROJECT_ID + "/locations/" + LOCATION_ID + "/publishers/google/models/virtual-try-on-001:predict";
  return proxyVertex(url, payload);
}

function proxyVertex(url, payload) {
  var options = {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload),
    headers: { Authorization: "Bearer " + ScriptApp.getOAuthToken() },
    muteHttpExceptions: true
  };
  var response = UrlFetchApp.fetch(url, options);
  return ContentService.createTextOutput(response.getContentText()).setMimeType(ContentService.MimeType.JSON);
}

function handleUpload(base64, filename) {
  try {
    var folderName = "VTO_KIOSK_UPLOADS";
    var folders = DriveApp.getFoldersByName(folderName);
    var folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(folderName);
    
    var contentType = base64.substring(base64.indexOf(":") + 1, base64.indexOf(";"));
    var bytes = Utilities.base64Decode(base64.split(",")[1]);
    var blob = Utilities.newBlob(bytes, contentType, filename);
    var file = folder.createFile(blob);
    
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return ContentService.createTextOutput(JSON.stringify({
      id: file.getId(),
      url: "https://drive.google.com/file/d/" + file.getId() + "/view",
      success: true
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- SECTION 2: MANIFEST (appsscript.json) ---

/*
{
  "timeZone": "Asia/Kuala_Lumpur",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/cloud-platform",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/drive"
  ]
}
*/
